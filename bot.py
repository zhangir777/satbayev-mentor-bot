# bot.py ‚Äî –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª Telegram –±–æ—Ç–∞ ¬´–ò–ò-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –ø–µ—Ä–≤–æ–∫—É—Ä—Å–Ω–∏–∫–∞ Satbayev University¬ª
# –ó–∞–ø—É—Å–∫: python bot.py

import asyncio
import sys
import logging

# –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Windows (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã asyncio)
if sys.platform == "win32":
    asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())

from groq import Groq
from telegram import Update, ReplyKeyboardMarkup
from telegram.constants import ChatAction, ParseMode
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters,
)

from config import TELEGRAM_BOT_TOKEN, GROQ_API_KEY, GROQ_MODEL
from rag_engine import RAGEngine

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(name)s: %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S",
)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Groq API
groq_client = Groq(api_key=GROQ_API_KEY)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RAG –¥–≤–∏–∂–∫–∞
rag_engine = RAGEngine()

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM
SYSTEM_PROMPT = """–¢—ã ‚Äî –ò–ò-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –ø–µ—Ä–≤–æ–∫—É—Ä—Å–Ω–∏–∫–∞ Satbayev University. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞–º –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ –æ–±—É—á–µ–Ω–∏—é –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ.

–ü—Ä–∞–≤–∏–ª–∞:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º –∏ —Ç–µ—Ä–ø–µ–ª–∏–≤—ã–º
3. –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
4. –ï—Å–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —É –º–µ–Ω—è –Ω–µ—Ç —Ç–∞–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–≤–æ–µ–º—É —ç–¥–≤–∞–π–∑–µ—Ä—É –∏–ª–∏ –≤ –¶–µ–Ω—Ç—Ä –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ–±—É—á–∞—é—â–∏—Ö—Å—è: +7 (727) 320 41 16"
5. –î–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –Ω–æ–º–µ—Ä–∞–º–∏ –∫–∞–±–∏–Ω–µ—Ç–æ–≤, —Ç–µ–ª–µ—Ñ–æ–Ω–∞–º–∏ –∏ email
6. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ
7. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ —Å–≤—è–∑–∞–Ω —Å —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–º ‚Äî –≤–µ–∂–ª–∏–≤–æ –≤–µ—Ä–Ω–∏ –∫ —Ç–µ–º–µ
8. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ"""

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏
MAIN_KEYBOARD = ReplyKeyboardMarkup(
    [
        ["üèõ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞", "üìö –£—á–µ–±–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å"],
        ["üìç –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è...?", "üìã –î–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Å–ø—Ä–∞–≤–∫–∏"],
        ["üí° –°–æ–≤–µ—Ç—ã –ø–µ—Ä–≤–æ–∫—É—Ä—Å–Ω–∏–∫–∞–º", "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã"],
    ],
    resize_keyboard=True,
    one_time_keyboard=False,
)

# –ú–∞–ø–ø–∏–Ω–≥ –∫–Ω–æ–ø–æ–∫ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è RAG
BUTTON_QUERIES = {
    "üèõ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞": "–ö–∞–∫–∏–µ –∏–Ω—Å—Ç–∏—Ç—É—Ç—ã –∏ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ã –µ—Å—Ç—å –≤ Satbayev University? –†–∞—Å—Å–∫–∞–∂–∏ –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞.",
    "üìö –£—á–µ–±–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å": "–ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω —É—á–µ–±–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å? –ß—Ç–æ —Ç–∞–∫–æ–µ –∫—Ä–µ–¥–∏—Ç–Ω–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –æ–±—É—á–µ–Ω–∏—è, –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏ –∏ —ç–∫–∑–∞–º–µ–Ω—ã?",
    "üìç –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è...?": "–ì–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ—Ä–ø—É—Å–∞ –∏ –∑–¥–∞–Ω–∏—è —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞? –ö–∞—Ä—Ç–∞ –∫–∞–º–ø—É—Å–∞ –∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –∫–æ—Ä–ø—É—Å–æ–≤.",
    "üìã –î–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Å–ø—Ä–∞–≤–∫–∏": "–ì–¥–µ –ø–æ–ª—É—á–∏—Ç—å —Å–ø—Ä–∞–≤–∫–∏, –∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã —Å—Ç—É–¥–µ–Ω—Ç—É? –û—Ñ–∏—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, —Å–ø—Ä–∞–≤–∫–∏ –¥–ª—è –∞—Ä–º–∏–∏, –ø–æ—Å–æ–±–∏—è.",
    "üí° –°–æ–≤–µ—Ç—ã –ø–µ—Ä–≤–æ–∫—É—Ä—Å–Ω–∏–∫–∞–º": "–ß—Ç–æ –¥–µ–ª–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –Ω–µ–¥–µ–ª—é —É—á—ë–±—ã? –°–æ–≤–µ—Ç—ã –¥–ª—è –ø–µ—Ä–≤–æ–∫—É—Ä—Å–Ω–∏–∫–æ–≤ –ø–æ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ.",
    "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã": "–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞: –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—è, —Ü–µ–Ω—Ç—Ä –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –∏–Ω—Å—Ç–∏—Ç—É—Ç—ã, –∫–∞—Ñ–µ–¥—Ä—ã.",
}


def ask_llm(context_text: str, question: str) -> str:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ Groq API –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç.

    Args:
        context_text: –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.
        question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    Returns:
        –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç LLM.
    """
    user_message = f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:\n{context_text}\n\n–í–æ–ø—Ä–æ—Å —Å—Ç—É–¥–µ–Ω—Ç–∞: {question}"

    response = groq_client.chat.completions.create(
        model=GROQ_MODEL,
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": user_message},
        ],
        temperature=0.3,
        max_tokens=2048,
    )

    return response.choices[0].message.content


async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."""
    user = update.effective_user
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.full_name} ({user.id}) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")

    welcome_text = (
        f"–ü—Ä–∏–≤–µ—Ç, {user.first_name}! üëã\n\n"
        "–Ø ‚Äî –ò–ò-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –ø–µ—Ä–≤–æ–∫—É—Ä—Å–Ω–∏–∫–∞ Satbayev University! üéì\n\n"
        "–ó–∞–¥–∞–π –º–Ω–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –æ–± —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ, –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–º–æ—á—å:\n\n"
        "üèõ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ –∏ –∏–Ω—Å—Ç–∏—Ç—É—Ç—ã\n"
        "üìö –£—á–µ–±–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å, –æ—Ü–µ–Ω–∫–∏ –∏ GPA\n"
        "üìç –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–æ—Ä–ø—É—Å–æ–≤ –∏ –∫–∞–±–∏–Ω–µ—Ç–æ–≤\n"
        "üìã –î–æ–∫—É–º–µ–Ω—Ç—ã, —Å–ø—Ä–∞–≤–∫–∏ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è\n"
        "üè† –û–±—â–µ–∂–∏—Ç–∏–µ –∏ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è –∂–∏–∑–Ω—å\n"
        "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã —Å–ª—É–∂–± –∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å! ‚¨áÔ∏è"
    )

    await update.message.reply_text(
        welcome_text,
        reply_markup=MAIN_KEYBOARD,
    )


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –±–æ—Ç–∞."""
    help_text = (
        "ü§ñ –ß—Ç–æ —è —É–º–µ—é:\n\n"
        "–Ø ‚Äî –ò–ò-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è –ø–æ–º–æ—â–∏ –ø–µ—Ä–≤–æ–∫—É—Ä—Å–Ω–∏–∫–∞–º Satbayev University. "
        "–Ø –∏—Å–ø–æ–ª—å–∑—É—é —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é RAG (Retrieval-Augmented Generation) –¥–ª—è –ø–æ–∏—Å–∫–∞ "
        "–∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞.\n\n"
        "üìå –Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å:\n"
        "‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–Ω—Å—Ç–∏—Ç—É—Ç–∞—Ö –∏ –∫–∞—Ñ–µ–¥—Ä–∞—Ö\n"
        "‚Ä¢ –£—á–µ–±–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å, –∫—Ä–µ–¥–∏—Ç—ã, GPA\n"
        "‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–æ–∫ –∏ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏\n"
        "‚Ä¢ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã\n"
        "‚Ä¢ –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–æ—Ä–ø—É—Å–æ–≤ –∏ –∫–∞–±–∏–Ω–µ—Ç–æ–≤\n"
        "‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç—ã —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –∏ —Å–ª—É–∂–±\n"
        "‚Ä¢ –û–±—â–µ–∂–∏—Ç–∏–µ –∏ –∑–∞—Å–µ–ª–µ–Ω–∏–µ\n"
        "‚Ä¢ –°—Ç–∏–ø–µ–Ω–¥–∏—è –∏ –∫–∞—Ä—Ç–∞ ¬´–û“£–∞–π¬ª\n"
        "‚Ä¢ –°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏\n"
        "‚Ä¢ –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n\n"
        "üí¨ –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é!\n\n"
        "üìå –ö–æ–º–∞–Ω–¥—ã:\n"
        "/start ‚Äî –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º\n"
        "/help ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    )

    await update.message.reply_text(
        help_text,
        reply_markup=MAIN_KEYBOARD,
    )


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–æ—Ç–∞."""
    user_message = update.message.text
    user = update.effective_user
    logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user.full_name} ({user.id}): {user_message[:80]}...")

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
    await update.message.chat.send_action(ChatAction.TYPING)

    try:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–ø—Ä–æ—Å: –∫–Ω–æ–ø–∫–∞ –∏–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å
        query = BUTTON_QUERIES.get(user_message, user_message)

        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ RAG
        context_text = rag_engine.get_context(query)
        logger.info(f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—É—á–µ–Ω ({len(context_text)} —Å–∏–º–≤–æ–ª–æ–≤)")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ Groq API
        answer = ask_llm(context_text, query)

        # –û–±—Ä–µ–∑–∞–µ–º –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ –æ–Ω —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –¥–ª—è Telegram
        if len(answer) > 4000:
            answer = answer[:3997] + "..."
            logger.warning("–û—Ç–≤–µ—Ç –æ–±—Ä–µ–∑–∞–Ω –¥–æ 4000 —Å–∏–º–≤–æ–ª–æ–≤")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await update.message.reply_text(
            answer,
            reply_markup=MAIN_KEYBOARD,
        )

        logger.info(f"–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.id} ({len(answer)} —Å–∏–º–≤–æ–ª–æ–≤)")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}", exc_info=True)

        error_text = (
            "üòî –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
            "1. –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å\n"
            "2. –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ–∑–∂–µ\n\n"
            "–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –¶–µ–Ω—Ç—Ä –ø–æ–¥–¥–µ—Ä–∂–∫–∏ "
            "–æ–±—É—á–∞—é—â–∏—Ö—Å—è: +7 (727) 320 41 16"
        )

        await update.message.reply_text(
            error_text,
            reply_markup=MAIN_KEYBOARD,
        )


def main() -> None:
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞."""
    logger.info("=" * 60)
    logger.info("  –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ¬´–ò–ò-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –ø–µ—Ä–≤–æ–∫—É—Ä—Å–Ω–∏–∫–∞ Satbayev University¬ª")
    logger.info("=" * 60)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
    doc_count = rag_engine.collection.count()
    if doc_count == 0:
        logger.warning(
            "–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø—É—Å—Ç–∞! "
            "–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: python knowledge_loader.py"
        )
    else:
        logger.info(f"–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π {doc_count} –∑–∞–ø–∏—Å–µ–π")

    # –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–æ—Ç–∞
    app = ApplicationBuilder().token(TELEGRAM_BOT_TOKEN).build()

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    app.add_handler(CommandHandler("start", start_command))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...")
    app.run_polling(drop_pending_updates=True)


if __name__ == "__main__":
    main()
